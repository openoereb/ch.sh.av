name: 'AV Sync'

on:
  schedule:
    # this is in UTC so it means every day at 3 AM this trigger is pulled
    - cron: 0 2 * * *
  workflow_dispatch:
    
jobs:
  sync:
    environment: sync
    name: 'AV Sync'
    runs-on: ubuntu-latest

    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest
    defaults:
      run:
        shell: bash
    env:
      DOWNLOAD_URL: https://www.geodienste.ch/downloads/interlis/av/SH
      FILE_NAME: av_SH_lv95.zip
      POSTGRES_PW: postgres

    steps:
    # Checkout the repository to the GitHub Actions runner
    - name: Checkout
      uses: actions/checkout@v3
    # Update references
    - name: Git checkout master
      run: |
        git checkout master
    # Download current AV state
    - name: Download AV
      run: |
        curl -X GET -o /tmp/av_SH_lv95.zip $DOWNLOAD_URL/$FILE_NAME
        ls -ls /tmp/$FILE_NAME
    - name: Unzip AV
      run: |
        unzip -o /tmp/$FILE_NAME '*.itf' -d ./
    - name: Commit changes
      run: |
        git add .
        git config --global user.email "${{ secrets.GIT_EMAIL }}"
        git config --global user.name "${{ secrets.GIT_NAME }}"
        DOWNLOAD_URL=$DOWNLOAD_URL FILE_NAME=$FILE_NAME FULL_REBUILD=${{ github.event.inputs.logLevel }} ./scripts/commit_push_if_dirty.sh
